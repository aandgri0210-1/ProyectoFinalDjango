{% extends 'base.html' %}
{% block content %}
<div class="container mt-4">
    <div class="card shadow-sm">
        <div class="card-header bg-danger text-white">
            <h2 class="h4 mb-0">Registrar Combate — {{ personaje.nombre }}</h2>
        </div>
        <div class="card-body">
            <p class="text-muted mb-4 small">
                Selecciona zona y enemigo para iniciar una batalla por turnos.
                El resultado se definirá dentro de la arena de combate.
            </p>

            <form method="post">
                {% csrf_token %}

                {% if form.non_field_errors %}
                <div class="alert alert-danger">
                    {% for e in form.non_field_errors %}
                    <div class="small">{{ e }}</div>
                    {% endfor %}
                </div>
                {% endif %}

                <div class="row">
                    <!-- Configuración del Encuentro -->
                    <div class="col-md-6 border-end">
                        <h5 class="mb-3 text-secondary">Configuración del Encuentro</h5>

                        <div class="mb-3">
                            <label class="form-label fw-bold">Personaje</label>
                            <div class="form-control bg-light h-auto">
                                <strong>{{ personaje.nombre }}</strong>
                            </div>
                            <div class="form-text small">Personaje fijo para este registro.</div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">{{ form.zona.label }}</label>
                            {{ form.zona }}
                            {% for e in form.zona.errors %}
                            <div class="text-danger small">{{ e }}</div>
                            {% endfor %}
                        </div>


                        <div class="mb-3">
                            <label class="form-label fw-bold">{{ form.enemigo.label }}</label>
                            {{ form.enemigo }}
                            <div class="form-text small">Selecciona un adversario específico.</div>
                            {% for e in form.enemigo.errors %}
                            <div class="text-danger small">{{ e }}</div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Inicio del Combate -->
                    <div class="col-md-6 px-4">
                        <h5 class="mb-3 text-secondary">Cómo funciona</h5>
                        <ul>
                            <li>Tu personaje y el enemigo atacan por turnos.</li>
                            <li>En tu turno podrás <strong>Atacar</strong> o <strong>Huir</strong>.</li>
                            <li>Si el enemigo es jefe, no podrás huir.</li>
                        </ul>
                    </div>
                </div>

                <div class="mt-4 pt-3 border-top d-flex justify-content-between">
                    <button type="submit" class="btn btn-danger px-4">
                        Iniciar Combate por Turnos
                    </button>
                    <a href="{% url 'juego:combate-list' personaje.id %}" class="btn btn-outline-secondary">
                        Cancelar y volver
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const zonaSelect = document.getElementById('id_zona');
        const enemigoSelect = document.getElementById('id_enemigo');

        if (!zonaSelect || !enemigoSelect) {
            console.error("No se encontraron los selectores de zona o enemigo.");
            return;
        }

        const allEnemies = Array.from(enemigoSelect.options);

        function filterEnemies() {
            const selectedZonaId = zonaSelect.value;
            const currentSelectedValue = enemigoSelect.value;

            console.log("Filtrando enemigos para zona ID:", selectedZonaId);

            enemigoSelect.innerHTML = '';

            const emptyOption = allEnemies.find(opt => opt.value === "");
            if (!selectedZonaId) {
                if (emptyOption) enemigoSelect.appendChild(emptyOption.cloneNode(true));
                enemigoSelect.disabled = true;
                return;
            }
            enemigoSelect.disabled = false;
            if (emptyOption) enemigoSelect.appendChild(emptyOption.cloneNode(true));

            let count = 0;
            allEnemies.forEach(option => {
                const enemyZonaId = option.getAttribute('data-zona-id');
                if (option.value !== "" && enemyZonaId === selectedZonaId) {
                    enemigoSelect.appendChild(option.cloneNode(true));
                    count++;
                }
            });

            console.log(`Encontrados ${count} enemigos para esta zona.`);

            const stillExists = Array.from(enemigoSelect.options).some(opt => opt.value === currentSelectedValue);
            enemigoSelect.value = stillExists ? currentSelectedValue : "";
        }

        zonaSelect.addEventListener('change', filterEnemies);
        filterEnemies();
    });
</script>

<style>
    .fw-bold {
        font-weight: 600;
    }

    .form-control:focus {
        border-color: #dc3545;
        box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
    }
</style>
{% endblock %}